# ğŸ§  RECAP KIáº¾N TRÃšC â€“ SPARK LAB 4 â†’ 5 â†’ 6

(Shuffle â€“ Join â€“ Skew)

---

## ğŸ§© 1ï¸âƒ£ Big Picture: Spark thá»±c sá»± cháº¡y nhÆ° tháº¿ nÃ o?

```mermaid
flowchart LR
    A[Source Data] --> B[Transformations]
    B -->|Action| C[DAG]
    C --> D[Stages]
    D --> E[Tasks]
    E --> F[Executors]
```

ğŸ“Œ Má»i thá»© chá»‰ xáº£y ra khi cÃ³ ACTION

ğŸ“Œ Performance cháº¿t á»Ÿ Stage boundary (shuffle)

---

## ğŸ”€ 2ï¸âƒ£ LAB 4 â€“ SHUFFLE (Káºº GIáº¾T SPARK)

Khi nÃ o shuffle xáº£y ra?

```mermaid
flowchart TD
    A[map / filter] -->|NO shuffle| B[Same partition]
    B --> C[groupBy / join / distinct]
    C -->|SHUFFLE| D[Exchange]
```

**VÃ¬ sao shuffle nguy hiá»ƒm?**

-	Disk I/O
-	Network transfer
-	Memory pressure
-	Stage má»›i â†’ block pipeline

> ğŸ“Œ Má»—i Exchange = rá»§i ro

---

## ğŸ”— 3ï¸âƒ£ LAB 5 â€“ JOIN STRATEGIES

CÃ¡c chiáº¿n lÆ°á»£c join

```mermaid
flowchart LR
    A[Join] --> B{Table nhá»?}
    B -->|YES| C[BroadcastHashJoin]
    B -->|NO| D{Sorted?}
    D -->|YES| E[SortMergeJoin]
    D -->|NO| F[ShuffleHashJoin]
```

**Thá»© tá»± Æ°u tiÃªn (Spark):**

1.	BroadcastHashJoin â­
2.	SortMergeJoin
3.	ShuffleHashJoin âŒ

> ğŸ“Œ Join sai = cost + runtime + OOM

---

## ğŸ’¥ 4ï¸âƒ£ LAB 6 â€“ DATA SKEW (Káºº THÃ™ THáº¦M Láº¶NG)

Skew trÃ´ng nhÆ° tháº¿ nÃ o?

```mermaid
flowchart LR
    P1[Partition 1] -->|1% data| OK1[Fast]
    P2[Partition 2] -->|1% data| OK2[Fast]
    P3[Partition 3] -->|97% data| SLOW[Very slow ğŸ˜±]
```

> ğŸ“Œ 1 task cháº­m â†’ cáº£ stage Ä‘á»©ng hÃ¬nh

---

## ğŸ§‚ 5ï¸âƒ£ SALTING vs AQE

### Salting (manual)

```mermaid
flowchart LR
    HOT[HOT key] --> S1[HOT_1]
    HOT --> S2[HOT_2]
    HOT --> S3[HOT_3]
```

**âœ” Chia táº£i**
âŒ Code phá»©c táº¡p

âŒ KhÃ³ maintain

---

### AQE (Adaptive Query Execution)

```mermaid
flowchart LR
    Spark[Runtime] --> Detect[Detect Skew]
    Detect --> Split[Split Partition]
    Split --> Balanced[Balanced Tasks]
```

âœ” Tá»± Ä‘á»™ng

âœ” Clean code

âœ” Bank thÃ­ch ğŸ˜„

âŒ KhÃ´ng cá»©u Ä‘Æ°á»£c design sai náº·ng

---

## ğŸ¦ 6ï¸âƒ£ BANK-GRADE RULES (Cá»°C QUAN TRá»ŒNG)

### âŒ KHÃ”NG LÃ€M
-	Join nhiá»u báº£ng lá»›n á»Ÿ Gold
-	Retry vÃ´ háº¡n
-	Broadcast table skew
-	Tin config cá»©u design

### âœ… PHáº¢I LÃ€M
-	Explain plan trÆ°á»›c khi cháº¡y
-	Detect skew sá»›m
-	AQE báº­t máº·c Ä‘á»‹nh
-	Job < SLA / 2
-	Idempotent output

---

## ğŸ§  7ï¸âƒ£ TÆ¯ DUY KIáº¾N TRÃšC SÆ¯ (ÄINH NÃƒO)

Spark cháº­m khÃ´ng pháº£i vÃ¬ cluster yáº¿u
â†’ MÃ  vÃ¬ data shape & execution plan sai

---

## ğŸ”œ BÆ¯á»šC TIáº¾P THEO â€“ LAB 7 (THá»°C CHIáº¾N Tá»”NG Há»¢P)

LAB 7 sáº½ lÃ m gÃ¬?

âœ” Orders lá»›n (skew)

âœ” Customers nhá»

âœ” Join Ä‘Ãºng chiáº¿n lÆ°á»£c

âœ” AQE báº­t

âœ” Explain & reasoning nhÆ° production

âœ” PhÃ¢n tÃ­ch â€œnáº¿u job nÃ y cháº¡y á»Ÿ bank thÃ¬ á»•n chÆ°a?â€

